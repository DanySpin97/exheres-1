# Copyright 2014 Jorge Aparicio
# Distributed under the terms of the GNU General Public License v2

SCM_SECONDARY_REPOSITORIES="
    docopt_rs
    hamcrest_rust
    rust_encoding
    rust_url
    semver
    toml_rs
"

SCM_docopt_rs_REPOSITORY="https://github.com/burntsushi/docopt.rs.git"
SCM_hamcrest_rust_REPOSITORY="https://github.com/carllerche/hamcrest-rust.git"
SCM_rust_encoding_REPOSITORY="https://github.com/lifthrasiir/rust-encoding.git"
SCM_rust_url_REPOSITORY="https://github.com/servo/rust-url.git"
SCM_semver_REPOSITORY="https://github.com/rust-lang/semver.git"
SCM_toml_rs_REPOSITORY="https://github.com/alexcrichton/toml-rs.git"

SNAPSHOT_DATE="2014-09-03"

require github [ user="rust-lang" ]

SUMMARY="The Rust package manager"
HOMEPAGE="http://crates.io"
TARBALL="${PN}-nightly-x86_64-unknown-linux-gnu.tar.gz"
DOWNLOADS="http://static.rust-lang.org/cargo-dist/${SNAPSHOT_DATE}/${TARBALL} -> ${SNAPSHOT_DATE}-${TARBALL}"

LICENCES="Apache-2.0 MIT"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS=""

DEPENDENCIES="
    build+run:
        dev-lang/rust[=scm]
"

src_unpack() {
    scm_src_unpack

    # Place the snapshot where expected
    edo mkdir -p "${WORK}"/target/dl
    edo cp "${FETCHEDDIR}/${SNAPSHOT_DATE}-${TARBALL}" "${WORK}"/target/dl/${TARBALL}
}

src_prepare() {
    default

    # Don't fetch the snapshot again
    edo sed -i 's/subprocess.*curl.*/0/' src/etc/dl-snapshot.py
    edo sed -i '0,/.*rmtree.*/s//    pass/' src/etc/dl-snapshot.py
}

src_configure() {
    edo ./configure --prefix=/usr
}
